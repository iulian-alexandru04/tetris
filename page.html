<!DOCTYPE html>
<html>
<body>

<div align="center">
<canvas id="myCanvas" width="500" height="750" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<h1 id="msg"></h1>
</div>

<script>
    function draw_rectangle(Y, X, C)
    {
        if(C == undefined)
            return;
        ctx.fillStyle = C;
        ctx.fillRect(X*dim, Y*dim, dim, dim);
    }
    function draw_frame()
    {
        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        for(let i=0; i<max_y_blocks; i++)
            for(let j=0; j<max_x_blocks; j++)
                draw_rectangle(i, j, block_matrix[i][j]);
        draw_rectangle(y, x, c);
        ctx.stroke();
    }
    function key_handler(event)
    {
        var left_key = 37;
        var right_key = 39;
        if(event.keyCode == right_key)
            if(valid_position(y, x+1))
                x++;
        
        if(event.keyCode == left_key)
            if(valid_position(y, x-1))
                x--;

        draw_frame();
    }
    function push_down()
    {
        if(valid_position(y+1, x))
        {
            y++;
        }
        else
        {
            keep_in_place(y, x, c);
            generate_block();
        }
        draw_frame();
    }
    function valid_position(y, x)
    {
        if(x < 0 || x >= max_x_blocks)
            return false;

        if(y < 0 || y >= max_y_blocks)
            return false;

        return !overlap(y, x);
    }
    function overlap(y, x)
    {
        return block_matrix[y][x] != undefined;
    }
    function remove_blocks_from_line_and_shift_others(y)
    {
        for(let i=y; i>0; i--)
            block_matrix[i] = block_matrix[i-1];
        block_matrix[0] = new Array(max_x_blocks);
    }
    function remove_blocks_if_complete_line()
    {
        for(let i=max_y_blocks-1; i>=0; i--)
        {
            complete_line = true;
            for(j=0; j<max_x_blocks && complete_line; j++)
                if(!overlap(i, j))
                    complete_line = false;
            if(complete_line)
                remove_blocks_from_line_and_shift_others(i);
        }
    }
    function keep_in_place(y, x, c)
    {
        block_matrix[y][x] = c;
        remove_blocks_if_complete_line();
    }
    function generate_block()
    {
        if(valid_position(0, 1))
        {
            y = 0;
            x = 1;
            c = '#'+Math.floor(Math.random()*16777215).toString(16);
        }
        else
        {
            document.getElementById("msg").innerHTML = "Game Over!"
            clearInterval(push_down_interval);
        }
        draw_frame();
    }
var y = 0;
var x = 1;
var c = "#000000";
var dim = 50;
var width = 500;
var height = 750;
var max_y_blocks = height / dim;
var max_x_blocks = width / dim;
var my_canvas = document.getElementById("myCanvas");
var ctx = my_canvas.getContext("2d");
var block_matrix = [];
for(let i=0; i<max_y_blocks; i++) {
    block_matrix[i] = new Array(max_x_blocks);
}
push_down_interval = setInterval(push_down, 200);
window.addEventListener("keydown", key_handler);
</script>

</body>
</html>
<!DOCTYPE html>
<html>
<body>

<div align="center">
<canvas id="myCanvas" width="500" height="750" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<h1 id="msg"></h1>
</div>

<script>
    function draw_rectangle(Y, X, C)
    {
        if(C == undefined)
            return;
        ctx.fillStyle = C;
        ctx.fillRect(X*dim, Y*dim, dim, dim);
    }
    function draw_piece(piece)
    {
        if(piece == undefined)
            return;
        for(block of piece.shape)
            draw_rectangle(block[0]+piece.y_offset, block[1]+piece.x_offset, piece.color);
    }
    function draw_frame()
    {
        ctx.clearRect(0, 0, width, height);
        ctx.beginPath();
        for(let i=0; i<max_y_blocks; i++)
            for(let j=0; j<max_x_blocks; j++)
                draw_rectangle(i, j, block_matrix[i][j]);
        draw_piece(piece);
        ctx.stroke();
    }
    function valid_piece_offset(piece, delta_y, delta_x)
    {
        for(block of piece.shape)
        {
            if(!valid_position(block[0]+piece.y_offset+delta_y, 
                               block[1]+piece.x_offset+delta_x))
                return false;
        }
        return true;
    }
    function key_handler(event)
    {
        var left_key = 37;
        var right_key = 39;
        if(event.keyCode == right_key)
            if(valid_piece_offset(piece, 0, 1))
                piece.x_offset++;
        
        if(event.keyCode == left_key)
            if(valid_piece_offset(piece, 0, -1))
                piece.x_offset--;

        draw_frame();
    }
    function push_down()
    {
        if(valid_piece_offset(piece, 1, 0))
            piece.y_offset++;
        else
        {
            keep_in_place(piece);
            generate_block();
        }
        draw_frame();
    }
    function valid_position(y, x)
    {
        if(x < 0 || x >= max_x_blocks)
            return false;

        if(y < 0 || y >= max_y_blocks)
            return false;

        return !overlap(y, x);
    }
    function overlap(y, x)
    {
        return block_matrix[y][x] != undefined;
    }
    function remove_blocks_from_line_and_shift_others(y)
    {
        for(let i=y; i>0; i--)
            block_matrix[i] = block_matrix[i-1];
        block_matrix[0] = new Array(max_x_blocks);
    }
    function remove_blocks_if_complete_line()
    {
        for(let i=max_y_blocks-1; i>=0; i--)
        {
            complete_line = true;
            for(let j=0; j<max_x_blocks && complete_line; j++)
                if(!overlap(i, j))
                    complete_line = false;
            if(complete_line)
                remove_blocks_from_line_and_shift_others(i);
        }
    }
    function keep_in_place(piece)
    {
        for(block of piece.shape)
            block_matrix[block[0]+piece.y_offset][block[1]+piece.x_offset] = piece.color;
        remove_blocks_if_complete_line();
    }
    function gen_shape()
    {
        return [[0, 0]];
    }
    function generate_block()
    {
        crt_shape = gen_shape();
        crt_color = '#'+Math.floor(Math.random()*16777215).toString(16);
        piece = {shape:crt_shape, color:crt_color, y_offset:0, x_offset:3};
        if(!valid_piece_offset(piece, 0, 0))
        {
            piece = undefined;
            document.getElementById("msg").innerHTML = "Game Over!"
            clearInterval(push_down_interval);
        }
        draw_frame();
    }
var piece = {shape:[[0, 0], [0, 1]], color:"#000000", y_offset:0, x_offset:3};
var dim = 50;
var width = 500;
var height = 750;
var max_y_blocks = height / dim;
var max_x_blocks = width / dim;
var my_canvas = document.getElementById("myCanvas");
var ctx = my_canvas.getContext("2d");
var block_matrix = [];
for(let i=0; i<max_y_blocks; i++) {
    block_matrix[i] = new Array(max_x_blocks);
}
push_down_interval = setInterval(push_down, 200);
window.addEventListener("keydown", key_handler);
</script>

</body>
</html>